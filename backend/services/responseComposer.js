// backend/services/responseComposer.js
// ๐ฏ ูุฏู: ุชููุฏ ูพุงุณุฎ ููุง ุทุจุนุ ุฎูุงุตูุ ู ูฺฉุงูููโุง ุจุฑุง ฺฉุงุฑุจุฑ

/**
 * ุชูุฒฺฉููุฏู ู ุจุงุฒููุณ ูพุงุณุฎ ููุง
 * ุญุฐู ุนุจุงุฑุงุช ุณุณุชูุ ุงุตูุงุญ ุฌููุงุช ูุงูุตุ ู ุงุถุงููโฺฉุฑุฏู ูุญู ุงูุณุงู
 */
export function composeFinalAnswer(ragHits = [], draftAnswer = "") {
  if (!draftAnswer) return { text: "ูพุงุณุฎ ูพุฏุง ูุดุฏุ ูุทูุงู ุณุคุงู ุฑุง ูุงุถุญโุชุฑ ุจูพุฑุณุฏ ๐" };

  let text = draftAnswer.trim();

  // ๐งน ุญุฐู ุชูุถุญุงุช ูู ู ุจโุฑุจุท
  const filters = [
    /(FAQ|RAG|context|database|ูพุงฺฏุงู ุฏุงุฏู|context|ุฏุฑ ุณูุงูุงุช ูุชุฏุงูู|ุฏุฑ ุฏุชุงุจุณ|ุจุฑุฑุณ ฺฉุฑุฏู|ุฑูุชู ุจุฑุฑุณ ฺฉูู|ุงูุช ูุดุฏ)/gi,
    /(ุงูุงู ุจุฑุฑุณ ูโฺฉูู|ุฏุฑ ุญุงู ุจุฑุฑุณ ูุณุชู|ุจู ุณุฑุงุบ|ุงูุงู ุณุฑุงุบ|ุฏุฑ ุญุงู ุญุงุถุฑ ุจุฑุฑุณ ุดุฏ)/gi,
    /(ูพุงุณุฎ ูุณุชูู ูุฌูุฏ ูุฏุงุฑุฏ|ุฏุฑ ุณูุงูุงุช ููุฌูุฏ ูุจูุฏ|ุงุทูุงุนุงุช ุฎุงุต ูุณุช)/gi,
    /\(\s*ุชูุฌู.*?\)/gi,
  ];
  filters.forEach((r) => (text = text.replace(r, "")));

  // ๐ค ุญุฐู ูุงุตููโูุง ู ุฎุทูุท ุงุถุงู
  text = text.replace(/\n{2,}/g, "\n").replace(/\s{2,}/g, " ").trim();

  // ๐ง ุงุตูุงุญ ุดุฑูุน ูพุงุณุฎ
  text = text
    .replace(/^ุงุจุชุฏุง\s.*?(?:ุ|\.| )/gi, "")
    .replace(/^ุญุงูุง\s.*?(?:ุ|\.| )/gi, "")
    .replace(/^ุณุคุงู\s.*?(?:ุ|\.| )/gi, "")
    .replace(/^ูพุงุณุฎ\s.*?(?:ุ|\.| )/gi, "")
    .trim();

  // โจ ุจุงุฒููุณ ูพุงุงู ูุชู (ุฏุนูุช ุจู ุชุนุงูู ุงูุณุงู)
  const endings = [
    "ุงฺฏู ุฎูุงุณุช ุฏุฑุจุงุฑู ุฏูุฑูโูุง ุง ุฒูุงูุดูู ุจุดุชุฑ ุจุฏููุ ุฎูุดุญุงู ูโุดู ุฑุงูููุงุช ฺฉูู ๐",
    "ุงฺฏุฑ ุณุคุงู ุฏฺฏูโุง ุฏุงุดุช ุง ูโุฎูุง ุฏููโุชุฑ ุจุฏููุ ุฏุฑ ุฎุฏูุชุชู ๐",
    "ูโุฎูุง ุฌุฒุฆุงุช ุซุจุชโูุงูุด ุฑู ูู ุจุฑุงุช ุจุงุฑูุ",
  ];

  // ุงฺฏุฑ ุฌูุงุจ ุฎุดฺฉ ุชููู ุดุฏูุ ู ูพุงุงู ุฏูุณุชุงูู ุงุถุงูู ฺฉู
  if (!/[.!ุ]$/.test(text)) text += " ๐";

  if (text.length < 200 && !/๐|๐|๐/.test(text)) {
    text += "\n" + endings[Math.floor(Math.random() * endings.length)];
  }

  // โ๏ธ ุงฺฏุฑ ุฌูููโูุง ุชฺฉุฑุงุฑ ุง ุฎุณุชูโฺฉููุฏู ูุฌูุฏ ุฏุงุดุชุ ุญุฐู ฺฉู
  text = text
    .replace(/(ุงฺฏุฑ ุฎูุงุณุช ุฏููโุชุฑ ุจุฏููุ ุฎูุดุญุงู ูโุดู ุฑุงูููุงุช ฺฉูู)\s*(\1)+/gi, "$1")
    .replace(/(\s*\n\s*){2,}/g, "\n");

  return { text: text.trim(), confidence: 0.95 };
}
