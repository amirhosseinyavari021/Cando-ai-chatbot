// backend/services/responseComposer.js
// 🎯 هدف: تولید پاسخ نهایی طبیعی، خلاصه، و مکالمه‌ای برای کاربر

/**
 * تمیزکننده و بازنویس پاسخ نهایی
 * حذف عبارات سیستمی، اصلاح جملات ناقص، و اضافه‌کردن لحن انسانی
 */
export function composeFinalAnswer(ragHits = [], draftAnswer = "") {
  if (!draftAnswer) return { text: "پاسخی پیدا نشد، لطفاً سؤال را واضح‌تر بپرسید 😊" };

  let text = draftAnswer.trim();

  // 🧹 حذف توضیحات فنی و بی‌ربط
  const filters = [
    /(FAQ|RAG|context|database|پایگاه داده|context|در سوالات متداول|در دیتابیس|بررسی کردم|رفتم بررسی کنم|یافت نشد)/gi,
    /(الان بررسی می‌کنم|در حال بررسی هستم|به سراغ|الان سراغ|در حال حاضر بررسی شد)/gi,
    /(پاسخ مستقیم وجود ندارد|در سوالات موجود نبود|اطلاعات خاصی نیست)/gi,
    /\(\s*توجه.*?\)/gi,
  ];
  filters.forEach((r) => (text = text.replace(r, "")));

  // 🔤 حذف فاصله‌ها و خطوط اضافی
  text = text.replace(/\n{2,}/g, "\n").replace(/\s{2,}/g, " ").trim();

  // 🧠 اصلاح شروع پاسخ
  text = text
    .replace(/^ابتدا\s.*?(?:،|\.| )/gi, "")
    .replace(/^حالا\s.*?(?:،|\.| )/gi, "")
    .replace(/^سؤال\s.*?(?:،|\.| )/gi, "")
    .replace(/^پاسخ\s.*?(?:،|\.| )/gi, "")
    .trim();

  // ✨ بازنویسی پایان متن (دعوت به تعامل انسانی)
  const endings = [
    "اگه خواستی درباره دوره‌ها یا زمانشون بیشتر بدونی، خوشحال می‌شم راهنماییت کنم 🌟",
    "اگر سؤال دیگه‌ای داشتی یا می‌خوای دقیق‌تر بدونی، در خدمتتم 🙂",
    "می‌خوای جزئیات ثبت‌نامش رو هم برات بیارم؟",
  ];

  // اگر جواب خشک تموم شده، یه پایان دوستانه اضافه کن
  if (!/[.!؟]$/.test(text)) text += " 🙂";

  if (text.length < 200 && !/🙂|🌟|😉/.test(text)) {
    text += "\n" + endings[Math.floor(Math.random() * endings.length)];
  }

  // ✂️ اگر جمله‌های تکراری یا خسته‌کننده وجود داشت، حذف کن
  text = text
    .replace(/(اگر خواستی دقیق‌تر بدونی، خوشحال می‌شم راهنماییت کنم)\s*(\1)+/gi, "$1")
    .replace(/(\s*\n\s*){2,}/g, "\n");

  return { text: text.trim(), confidence: 0.95 };
}
